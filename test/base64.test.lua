base64 = require('lib/base64')

local function dumpChars(str)
    for i = 1, #str do
        io.write(string.byte(str, i) .. ' ')
    end
    io.write('\n')
end

local function test()
    local str = 'Hello, world!'
    local encoded = 'SGVsbG8sIHdvcmxkIQ=='
    local decoded = base64.decode(encoded)

    print('"' .. decoded .. '"' .. ' == ' .. '"' .. str .. '"' .. ': ' .. tostring(decoded == str))
    dumpChars(decoded)
    dumpChars(str)
    assert(base64.decode(encoded) == str)

    print('Success!')

    local long =
    "bG9jYWwgUCA9IHt9CmFyZ3BhcnNlID0gUAoKbG9jYWwgbWV0YSA9IHt9Cgpm\ndW5jdGlvbiBQLm5ldygpCiAgICBsb2NhbCBzZWxmID0gc2V0bWV0YXRhYmxl\nKHt9LCB7X19pbmRleD1tZXRhfSkKICAgIHNlbGYubnBvcyA9IDAKICAgIHNl\nbGYuYXJncyA9IHt9CiAgICBzZWxmLmt3YXJncyA9IHt9CiAgICByZXR1cm4g\nc2VsZgplbmQKCmxvY2FsIFBPUyA9IDEKbG9jYWwgS1cgPSAyCgotLSBQYXJz\nZSBhbiBhcmd1bWVudCBuYW1lLCByZXR1cm5pbmcgdGhlIHR5cGUgYW5kIHRo\nZSBuYW1lLgotLSAnLS1uYW1lJyAtPiBLVywgJ25hbWUnCi0tICduYW1lJyAt\nPiBQT1MsICduYW1lCi0tICdteS1uYW1lJyAtPiBQT1MsICdteS1uYW1lJwps\nb2NhbCBmdW5jdGlvbiBwYXJzZV9uYW1lKGFyZ3VtZW50KQogICAgaWYgYXJn\ndW1lbnQ6c3ViKDEsIDIpID09ICctLScgdGhlbgogICAgICAgIHJldHVybiBL\nVywgYXJndW1lbnQ6c3ViKDMpCiAgICBlbHNlaWYgYXJndW1lbnQ6c3ViKDEs\nIDEpID09ICctJyB0aGVuCiAgICAgICAgcmV0dXJuIEtXLCBhcmd1bWVudDpz\ndWIoMikKICAgIGVsc2UKICAgICAgICByZXR1cm4gUE9TLCBhcmd1bWVudAog\nICAgZW5kCmVuZAoKbG9jYWwgZnVuY3Rpb24gcGFyc2Vfc2hvcnQoYXJndW1l\nbnQpCiAgICBpZiBhcmd1bWVudCA9PSBuaWwgdGhlbgogICAgICAgIHJldHVy\nbiBuaWwKICAgIGVuZAoKICAgIGlmIGFyZ3VtZW50OnN1YigxLCAxKSA9PSAn\nLScgdGhlbgogICAgICAgIHJldHVybiBhcmd1bWVudDpzdWIoMikKICAgIGVs\nc2UKICAgICAgICByZXR1cm4gbmlsCiAgICBlbmQKZW5kCgpmdW5jdGlvbiBt\nZXRhOmFkZF9hcmd1bWVudChhcmd1bWVudCwgaGVscCwgc2hvcnQpCiAgICBs\nb2NhbCB0cGUsIG5hbWUgPSBwYXJzZV9uYW1lKGFyZ3VtZW50KQogICAgbG9j\nYWwgc2hvcnRfbmFtZSA9IHBhcnNlX3Nob3J0KHNob3J0KQogICAgbG9jYWwg\nYXJnID0ge25hbWU9bmFtZSwgaGVscD1oZWxwLCBzaG9ydD1zaG9ydF9uYW1l\nfQogICAgaWYgdHBlID09IFBPUyB0aGVuCiAgICAgICAgc2VsZi5ucG9zID0g\nc2VsZi5ucG9zICsgMQogICAgICAgIHNlbGYuYXJnc1tzZWxmLm5wb3NdID0g\nYXJnCiAgICBlbHNlCiAgICAgICAgc2VsZi5rd2FyZ3NbbmFtZV0gPSBhcmcK\nICAgICAgICBpZiBzaG9ydCB0aGVuCiAgICAgICAgICAgIHNlbGYua3dhcmdz\nW3Nob3J0X25hbWVdID0gYXJnCiAgICAgICAgZW5kCiAgICBlbmQKCiAgICBy\nZXR1cm4gc2VsZgplbmQKCmZ1bmN0aW9uIG1ldGE6aGVscCgpCiAgICBwcmlu\ndCgiVXNhZ2U6ICIgLi4gYXJnWzBdIC4uICIgW29wdGlvbnNdIikKCiAgICBm\nb3IgbmFtZSwgYXJnIGluIHBhaXJzKHNlbGYuYXJncykgZG8KICAgICAgICBs\naW5lID0gIiAgIiAuLiBuYW1lCiAgICAgICAgaWYgYXJnLnNob3J0IHRoZW4K\nICAgICAgICAgICAgbGluZSA9IGxpbmUgLi4gIiwgIiAuLiBhcmcuc2hvcnQK\nICAgICAgICBlbmQKICAgICAgICBpZiBhcmcuaGVscCB0aGVuCiAgICAgICAg\nICAgIGxpbmUgPSBsaW5lIC4uICIgIiAuLiBhcmcuaGVscAogICAgICAgIGVu\nZAogICAgICAgIHByaW50KGxpbmUpCiAgICBlbmQKCiAgICBmb3IgbmFtZSwg\nYXJnIGluIHBhaXJzKHNlbGYua3dhcmdzKSBkbwogICAgICAgIGxpbmUgPSAi\nICAtLSIgLi4gbmFtZQogICAgICAgIGlmIGFyZy5zaG9ydCB0aGVuCiAgICAg\nICAgICAgIGxpbmUgPSBsaW5lIC4uICIsIC0iIC4uIGFyZy5zaG9ydAogICAg\nICAgIGVuZAogICAgICAgIGlmIGFyZy5oZWxwIHRoZW4KICAgICAgICAgICAg\nbGluZSA9IGxpbmUgLi4gIiAiIC4uIGFyZy5oZWxwCiAgICAgICAgZW5kCiAg\nICAgICAgcHJpbnQobGluZSkKICAgIGVuZAplbmQKCmZ1bmN0aW9uIG1ldGE6\ncGFyc2UoLi4uKQogICAgbG9jYWwgYXJncyA9IHt9CiAgICBsb2NhbCBrd2Fy\nZ3MgPSB7fQogICAgbG9jYWwgaSA9IDEKICAgIGxvY2FsIG5wb3MgPSAwCiAg\nICB3aGlsZSBpIDw9ICNhcmcgZG8KICAgICAgICBsb2NhbCBhcmd1bWVudCA9\nIGFyZ1tpXQogICAgICAgIGxvY2FsIHRwZSwgbmFtZSA9IHBhcnNlX25hbWUo\nYXJndW1lbnQpCiAgICAgICAgaWYgdHBlID09IFBPUyB0aGVuCiAgICAgICAg\nICAgIG5wb3MgPSBucG9zICsgMQogICAgICAgICAgICBsb2NhbCBhcmd0ID0g\nc2VsZi5hcmdzW25wb3NdCiAgICAgICAgICAgIGlmIGFyZ3QgPT0gbmlsIHRo\nZW4KICAgICAgICAgICAgICAgIHByaW50KCJVbmtub3duIGFyZ3VtZW50OiAi\nIC4uIG5hbWUpCiAgICAgICAgICAgICAgICBzZWxmOmhlbHAoKQogICAgICAg\nICAgICAgICAgb3MuZXhpdCgxKQogICAgICAgICAgICBlbmQKICAgICAgICAg\nICAgYXJnc1thcmd0Lm5hbWVdID0gYXJndW1lbnQKICAgICAgICBlbHNlCiAg\nICAgICAgICAgIGxvY2FsIGFyZ3QgPSBzZWxmLmt3YXJnc1tuYW1lXQogICAg\nICAgICAgICBpZiBhcmd0ID09IG5pbCB0aGVuCiAgICAgICAgICAgICAgICBw\ncmludCgiVW5rbm93biBhcmd1bWVudDogIiAuLiBuYW1lKQogICAgICAgICAg\nICAgICAgc2VsZjpoZWxwKCkKICAgICAgICAgICAgICAgIG9zLmV4aXQoMSkK\nICAgICAgICAgICAgZW5kCiAgICAgICAgICAgIGkgPSBpICsgMQogICAgICAg\nICAgICBrd2FyZ3NbYXJndC5uYW1lXSA9IGFyZ1tpXQogICAgICAgIGVuZAog\nICAgICAgIGkgPSBpICsgMQogICAgZW5kCiAgICByZXR1cm4gYXJncywga3dh\ncmdzCmVuZAoKcmV0dXJuIGFyZ3BhcnNl\n"
    local dec = base64.decode(long)
    print(dec)
end

test()
